<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map with Overpass Query and OSRM Routing</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #controls {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin: 10px auto;
            max-width: 100%;
            text-align: center; 
        }
        #map-container {
            height: calc(100% - 140px);
            width: 100%;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .distance {
            margin-top: 10px;
        }
        .btn-group {
            margin-top: 10px;
        }
        .btn {
            margin-right: 10px;
        }
        .leaflet-routing-container {
            display: none;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h4>Buscar:</h4>
        <select id="category">
            <option value="convenience">Comodidad</option>
            <option value="supermarket">Supermercado</option>
            <option value="clothes">Ropa</option>
            <option value="hairdresser">Peluquería</option>
            <option value="car_repair">Reparación de Automóviles</option>
            <option value="bakery">Panadería</option>
            <option value="car">Automóvil</option>
            <option value="beauty">Belleza</option>
            <option value="mobile_phone">Teléfono Móvil</option>
            <option value="hardware">Ferretería</option>
            <option value="butcher">Carnicería</option>
            <option value="furniture">Muebles</option>
            <option value="car_parts">Repuestos de Automóviles</option>
            <option value="alcohol">Alcohol</option>
            <option value="florist">Floristería</option>
            <option value="electronics">Electrónica</option>
            <option value="variety_store">Tienda de Variedades</option>
            <option value="shoes">Zapatos</option>
            <option value="mall">Centro Comercial</option>
            <option value="optician">Óptica</option>
            <option value="jewelry">Joyería</option>
            <option value="books">Libros</option>
            <option value="bicycle">Bicicleta</option>
            <option value="chemist">Farmacia</option>
            <option value="department_store">Almacén</option>
            <option value="laundry">Lavandería</option>
            <option value="travel_agency">Agencia de Viajes</option>
            <option value="pet">Mascota</option>
            <option value="stationery">Papelería</option>
            <option value="confectionery">Confitería</option>
            <option value="tyres">Neumáticos</option>
            <option value="computer">Computadora</option>
            <option value="copyshop">Copistería</option>
            <option value="beverages">Bebidas</option>
            <option value="funeral_directors">Funeraria</option>
            <option value="trade">Comercio</option>
            <option value="pastry">Pastelería</option>
            <option value="ticket">Boletos</option>
            <option value="deli">Delicatessen</option>
            <option value="paint">Pintura</option>
            <option value="pawnbroker">Casa de Empeño</option>
            <option value="outdoor">Aire Libre</option>
            <option value="antiques">Antigüedades</option>
            <option value="motorcycle_repair">Reparación de Motocicletas</option>
            <option value="video_games">Videojuegos</option>
            <option value="grocery">Comestibles</option>
        </select>
        <div class="btn-group">
            <button class="btn" onclick="previousLocation()">Anterior</button>
            <button class="btn" onclick="nextLocation()">Siguiente</button>
        </div>
        <div class="distance">
            Distance: <span id="route-distance">N/A</span> KM
        </div>
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        var map = L.map('map').setView([0, 0], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        var markers = [];
        var currentMarkerIndex = 0;
        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: true,
        }).addTo(map);

        var userMarker;

        function setUserLocation(lat, lon) {
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            userMarker = L.marker([lat, lon], {
                icon: L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            map.setView([lat, lon], 13);
        }

        function queryOverpassAPI(category) {
            var overpassUrl = 'https://overpass-api.de/api/interpreter';
            var query = '[out:json][timeout:25];' +
                        'area["name"="Luque"]->.searchArea;' +
                        'node["shop"="' + category + '"](area.searchArea);' +
                        'out body;';
            axios.post(overpassUrl, `data=${encodeURIComponent(query)}`)
                .then(response => {
                    var elements = response.data.elements;
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];

                    // Sort elements by distance to userMarker
                    elements.sort((a, b) => {
                        var distA = calculateDistance(userMarker.getLatLng(), L.latLng(a.lat, a.lon));
                        var distB = calculateDistance(userMarker.getLatLng(), L.latLng(b.lat, b.lon));
                        return distA - distB;
                    });

                    elements.forEach((element, index) => {
                        var marker = L.marker([element.lat, element.lon], {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                                shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);
                        markers.push(marker);
                        marker.bindPopup(element.tags.name || "Desconocido");
                    });
                    currentMarkerIndex = 0;
                    showMarkerAtIndex(currentMarkerIndex);
                    updateRoute();
                })
                .catch(error => console.error('Error querying Overpass API:', error));
        }

        function showMarkerAtIndex(index) {
            if (markers.length > 0) {
                map.setView(markers[index].getLatLng(), 13);
                markers[index].openPopup();
            }
        }

        function previousLocation() {
            if (currentMarkerIndex > 0) {
                currentMarkerIndex--;
                showMarkerAtIndex(currentMarkerIndex);
                updateRoute();
            }
        }

        function nextLocation() {
            if (currentMarkerIndex < markers.length - 1) {
                currentMarkerIndex++;
                showMarkerAtIndex(currentMarkerIndex);
                updateRoute();
            }
        }

        function updateRoute() {
            if (userMarker && markers.length > 0) {
                routingControl.setWaypoints([
                    userMarker.getLatLng(),
                    markers[currentMarkerIndex].getLatLng()
                ]);

                routingControl.on('routesfound', function(e) {
                    var distance = e.routes[0].summary.totalDistance / 1000;
                    document.getElementById('route-distance').innerText = distance.toFixed(2);
                });
            }
        }

        function calculateDistance(latlng1, latlng2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(latlng2.lat - latlng1.lat);
            var dLon = deg2rad(latlng2.lng - latlng1.lng);
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(latlng1.lat)) * Math.cos(deg2rad(latlng2.lat)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            var distance = R * c; // Distance in km
            return distance;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        document.getElementById('category').addEventListener('change', function() {
            var category = this.value;
            queryOverpassAPI(category);
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                setUserLocation(lat, lon);
                queryOverpassAPI(document.getElementById('category').value);
            }, function(error) {
                console.error('Error obtaining location:', error);
                setUserLocation(-25.275282, -57.641662); // Default to Luque, Paraguay if geolocation fails
                queryOverpassAPI(document.getElementById('category').value);
            });
        } else {
            console.error('Geolocation is not supported by this browser.');
            setUserLocation(-25.275282, -57.641662); // Default to Luque, Paraguay if geolocation is not supported
            queryOverpassAPI(document.getElementById('category').value);
        }
    </script>
</body>
</html>
